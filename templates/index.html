<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse des Tokens Solana</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    
    


    <!-- Filtres -->
    <div class="controls">
        <button onclick="refreshCache()" class="refresh-button">
            Refresh data
        </button>

        <div class="search-container"></div>
        <input type="text" 
               id="tokenSearch" 
               placeholder="Rechercher un token..." 
               class="search-input">
        <button onclick="clearSearch()" class="clear-search">‚úï</button>
    </div>
    </div>
    <div class="filters-panel">
        <div class="suspicious-thresholds-container">
            <button id="toggleThresholds" class="toggle-button">
                Seuils de d√©tection ‚ñº
            </button>
            <div class="suspicious-thresholds" id="thresholdsPanel" style="display: none;">
                <div class="filter-options">
                    <label>
                        Variation volume suspect (%)
                        <div class="threshold-inputs">
                            <input type="number" id="volumeChangeMin" placeholder="Min" value="-50">
                            <input type="number" id="volumeChangeMax" placeholder="Max" value="100">
                        </div>
                    </label>
                    <label>
                        Variation prix suspect (%)
                        <div class="threshold-inputs">
                            <input type="number" id="priceChangeMin" placeholder="Min" value="-50">
                            <input type="number" id="priceChangeMax" placeholder="Max" value="100">
                        </div>
                    </label>
                    <label>
                        Ratio Vol/Liq suspect >
                        <input type="number" id="volLiqThreshold" value="5" step="0.1">
                    </label>
                    <label>
                        Ratio Vol/MC suspect >
                        <input type="number" id="volMcThreshold" value="3" step="0.1">
                    </label>
                    <label>
                        Ratio Liq/MC suspect <
                        <input type="number" id="liqMcThreshold" value="0.05" step="0.01">
                    </label>
                    <label>
                        Wallets 24h suspect <
                        <input type="number" id="wallets24hThreshold" value="100" step="10">
                    </label>
                    <label>
                        Holders suspect <
                        <input type="number" id="holdersThreshold" value="500" step="50">
                    </label>
                </div>
            </div>
        </div>
        <h3>Filtres</h3>
        <div class="filter-options">
            <label>
                <input type="checkbox" id="filter24h" checked>
                Tokens > 24h
            </label>
            <label>
                <input type="checkbox" id="filterSuspicious">
                Masquer les tokens suspects
            </label>
            <label>
                <input type="number" id="minLiquidity" placeholder="Liquidit√© min ($)">
                Liquidit√© minimum
            </label>
            <label>
                <input type="number" id="minVolume" placeholder="Volume min ($)">
                Volume minimum
            </label>
           
            <label>
                <input type="number" id="minMc" placeholder="MCap min ($)">
                Market Cap minimum
            </label>
            <label>
                <input type="number" id="maxMc" placeholder="MCap max ($)">
                Market Cap maximum
            </label>
            <label>
                <input type="number" id="minHolders" placeholder="Holders min">
                Holders minimum
            </label>
            <label>
                <input type="number" id="minWallets24h" placeholder="Wallets 24h min">
                Wallets 24h minimum
            </label>
            <label>
                <input type="number" id="minPriceChange" placeholder="Variation prix min (%)">
                Variation prix minimum
            </label>
            <label>
                <input type="number" id="maxPriceChange" placeholder="Variation prix max (%)">
                Variation prix maximum
            </label>
            <label>
                <input type="number" id="minVolumeChange" placeholder="Variation volume min (%)">
                Variation volume minimum
            </label>
            <label>
                <input type="number" id="maxVolumeChange" placeholder="Variation volume max (%)">
                Variation volume maximum
            </label>
        </div>
        <button id="applyFilters">Appliquer les filtres</button>
    </div>

    <div class="filter-stats">
        <span id="visibleCount">{{ tokens|length }} tokens affich√©s</span>
        <button id="resetFilters" class="reset-button">R√©initialiser les filtres</button>
    </div>
    <div class="score-weights-container">
        <button id="toggleWeights" class="toggle-button">
            Coefficients du Score ‚ñº
        </button>
        <div class="score-weights" id="weightsPanel" style="display: none;">
            <div class="weight-options">
                <label>
                    Variation Volume 24h
                    <input type="number" id="volumeChangeWeight" value="0.10" step="0.05" min="0" max="1">
                </label>
                <label>
                    Variation Prix 24h
                    <input type="number" id="priceChangeWeight" value="0.10" step="0.05" min="0" max="1">
                </label>
                <label>
                    Volume
                    <input type="number" id="volumeWeight" value="0.15" step="0.05" min="0" max="1">
                </label>
                <label>
                    Liquidit√©
                    <input type="number" id="liquidityWeight" value="0.15" step="0.05" min="0" max="1">
                </label>
                <label>
                    Ratio Vol/Liq
                    <input type="number" id="volLiqWeight" value="0.20" step="0.05" min="0" max="1">
                </label>
                <label>
                    Ratio Vol/MC
                    <input type="number" id="volMcWeight" value="0.20" step="0.05" min="0" max="1">
                </label>
                <label>
                    Ratio Liq/MC
                    <input type="number" id="liqMcWeight" value="0.15" step="0.05" min="0" max="1">
                </label>
            </div>
            <div class="weight-total">Total: <span id="weightTotal">1.00</span></div>
            <button id="applyWeights">Appliquer les coefficients</button>
        </div>
    </div>

    <div class="column-visibility-container">
        <button id="toggleColumns" class="toggle-button">
            Visibilit√© des colonnes ‚ñº
        </button>
        <div class="column-toggles" id="columnsPanel" style="display: none;">
            <div class="column-options">
                <label><input type="checkbox" data-column="symbol" checked> Symbole</label>
                <label><input type="checkbox" data-column="name" checked> Nom</label>
                <label><input type="checkbox" data-column="liquidity" checked> Liquidit√©</label>
                <label><input type="checkbox" data-column="v24hUSD" checked> Volume 24h</label>
                <label><input type="checkbox" data-column="mc" checked> Market Cap</label>
                <label><input type="checkbox" data-column="v24hChangePercent" checked> Variation Volume 24h</label>
                <label><input type="checkbox" data-column="price_change_24h" checked> Variation Prix 24h</label>
                <label><input type="checkbox" data-column="volume_liquidity_ratio" checked> Vol/Liq</label>
                <label><input type="checkbox" data-column="volume_mc_ratio" checked> Vol/MC</label>
                <label><input type="checkbox" data-column="liquidity_mc_ratio" checked> Liq/MC</label>
                <label><input type="checkbox" data-column="performance" checked> Score</label>
                <label><input type="checkbox" data-column="is_pump" > Pump</label>
                <label><input type="checkbox" data-column="bubblemaps" > Bubblemaps</label>
                <label>
                    <input type="checkbox" data-column="holders" checked>
                    Holders
                </label>
                <label>
                    <input type="checkbox" data-column="unique_wallets_24h" checked>
                    Wallets 24h
                </label>
                <label>
                    <input type="checkbox" data-column="wallet_change" checked>
                    Œî Wallets
                </label>
            </div>
        </div>
    </div>

    <!-- Contr√¥les de comparaison -->
    <div class="comparison-controls">
        <button id="compareButton" disabled>Comparer les tokens s√©lectionn√©s</button>
        <span id="selectedCount">(0 s√©lectionn√©)</span>
    </div>


    


    {% if tokens %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th><a href="#" data-column="symbol" onclick="sortTable('symbol'); return false;">Symbole</a></th>
                    <th><a href="#" data-column="name" onclick="sortTable('name'); return false;">Nom</a></th>
                    <th><a href="#" data-column="liquidity" onclick="sortTable('liquidity'); return false;">Liq. ($)</a></th>
                    <th><a href="#" data-column="v24hUSD" onclick="sortTable('v24hUSD'); return false;">Vol. 24h ($)</a></th>
                    <th><a href="#" data-column="mc" onclick="sortTable('mc'); return false;">MCap ($)</a></th>
                    <th><a href="#" data-column="v24hChangePercent" onclick="sortTable('v24hChangePercent'); return false;" class="tooltip">
                        Œî Volume (%)
                        <span class="tooltiptext">Variation du volume sur 24h</span>
                    </a></th>
                    <th><a href="#" data-column="price_change_24h" onclick="sortTable('price_change_24h'); return false;" class="tooltip">
                        Œî Prix (%)
                        <span class="tooltiptext">Variation du prix sur 24h</span>
                    </a></th>
                    <th><a href="#" data-column="volume_liquidity_ratio" onclick="sortTable('volume_liquidity_ratio'); return false;" class="tooltip">
                        Vol/Liq
                        <span class="tooltiptext">Volume 24h / Liquidit√©</span>
                    </a></th>
                    <th><a href="#" data-column="volume_mc_ratio" onclick="sortTable('volume_mc_ratio'); return false;" class="tooltip">
                        Vol/MC
                        <span class="tooltiptext">Volume 24h / Market Cap</span>
                    </a></th>
                    <th><a href="#" data-column="liquidity_mc_ratio" onclick="sortTable('liquidity_mc_ratio'); return false;" class="tooltip">
                        Liq/MC
                        <span class="tooltiptext">Liquidit√© / Market Cap</span>
                    </a></th>
                    <th><a href="#" data-column="performance" onclick="sortTable('performance'); return false;" class="tooltip">
                        Score
                        <span class="tooltiptext">Score combin√© bas√© sur les ratios</span>
                    </a></th>

                    <th><a href="#" data-column="is_pump" onclick="sortTable('is_pump'); return false;" class="tooltip">
                        Pump
                        <span class="tooltiptext">Token avec adresse finissant par 'pump'</span>
                    </a></th>
                    <th><a href="#" data-column="bubblemaps" class="tooltip">
                        Bubblemaps
                        <span class="tooltiptext">Voir sur Bubblemaps</span>
                    </a></th>
                    <th>
                        <a href="#" data-column="holders" onclick="sortTable('holders'); return false;" class="tooltip">
                            Holders
                            <span class="tooltiptext">Nombre total de d√©tenteurs</span>
                        </a>
                    </th>
                    <th>
                        <a href="#" data-column="unique_wallets_24h" onclick="sortTable('unique_wallets_24h'); return false;" class="tooltip">
                            Wallets 24h
                            <span class="tooltiptext">Wallets uniques ayant trad√© en 24h</span>
                        </a>
                    </th>
                    <th>
                        <a href="#" data-column="wallet_change" onclick="sortTable('wallet_change'); return false;" class="tooltip">
                            Œî Wallets (%)
                            <span class="tooltiptext">√âvolution des wallets uniques</span>
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for token in tokens %}
                <tr>
                    <td><input type="checkbox" class="token-select" data-address="{{ token.address }}"></td>
                    <td style="cursor: pointer;" onclick="copyWithEffect(this, '{{ token.address }}')" title="Click to copy adress">{{ token.symbol }}</td>
                    <td>{{ token.name }}</td>
                    <td>{{ "{:,.0f}".format(token.liquidity).replace(',', ' ') }}</td>
                    <td>{{ "{:,.0f}".format(token.v24hUSD).replace(',', ' ') }}</td>
                    <td>{{ "{:,.0f}".format(token.mc).replace(',', ' ') }}</td>
                    <td class="{{ 'positive' if token.v24hChangePercent > 0 else 'negative' }} {{ 'suspicious' if token.v24hChangePercent > 100 or token.v24hChangePercent < -50 }}">
                        {{ "{:+.2f}%".format(token.v24hChangePercent) }}
                    </td>
                    <td class="{{ 'positive' if token.price_change_24h > 0 else 'negative' }} {{ 'suspicious' if token.price_change_24h > 100 or token.price_change_24h < -50 }}">
                        {{ "{:+.2f}%".format(token.price_change_24h) }}
                    </td>
                    <td class="{{ 'suspicious' if token.volume_liquidity_ratio > 5 }}">
                        {{ "{:.2f}".format(token.volume_liquidity_ratio) }}
                    </td>
                    <td class="{{ 'suspicious' if token.volume_mc_ratio > 3 }}">
                        {{ "{:.2f}".format(token.volume_mc_ratio) }}
                    </td>
                    <td class="{{ 'suspicious' if token.liquidity_mc_ratio < 0.05 }}">
                        {{ "{:.2f}".format(token.liquidity_mc_ratio) }}
                    </td>
                    <td class="{{ 'positive' if token.performance > 0 else 'negative' }}">
                        {{ "{:+.2f}".format(token.performance) }}
                    </td>
                    <td style="text-align: center;">{{ "‚úì" if token.is_pump else "" }}</td>
                    <td style="text-align: center;">
                        <a href="https://app.bubblemaps.io/sol/token/{{ token.address }}" 
                           target="_blank" 
                           class="bubblemaps-link" 
                           title="Voir sur Bubblemaps">
                            üîç
                        </a>
                    </td>
                    <td>{{ "{:,.0f}".format(token.holders|float) }}</td>
                    <td>{{ "{:,.0f}".format(token.unique_wallets_24h|float) }}</td>
                    <td class="{{ 'positive' if token.wallet_change > 0 else 'negative' }}">
                        {{ "{:+.2f}%".format(token.wallet_change|float) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p>Aucune donn√©e de token disponible.</p>
    {% endif %}

    <!-- Modal de comparaison -->
    <div id="comparisonModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Comparaison des tokens</h2>
            <div id="comparisonTable"></div>
        </div>
    </div>

    <!-- Script -->
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/search.js') }}"></script>
    <script src="{{ url_for('static', filename='js/columnVisibility.js') }}"></script>
    <script src="{{ url_for('static', filename='js/filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/comparison.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sorting.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        function refreshCache() {
            fetch('/refresh-cache')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();  // Recharger la page
                    } else {
                        alert('Erreur lors du rafra√Æchissement: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors du rafra√Æchissement des donn√©es');
                });
        }
    </script>
</body>
</html>