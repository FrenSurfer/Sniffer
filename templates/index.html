<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse des Tokens Solana</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Analyse des Tokens Solana</h1>
    
    <!-- Contrôles -->
    <div id="controls">
        <button onclick="localStorage.removeItem('columnWidths'); location.reload();">
            Réinitialiser les largeurs
        </button>
    </div>

    <!-- Filtres -->
    <div class="filters-panel">
        <div class="suspicious-thresholds-container">
            <button id="toggleThresholds" class="toggle-button">
                Seuils de détection ▼
            </button>
            <div class="suspicious-thresholds" id="thresholdsPanel" style="display: none;">
                <div class="filter-options">
                    <label>
                        Variation prix suspect (%)
                        <div class="threshold-inputs">
                            <input type="number" id="priceChangeMin" placeholder="Min" value="-50">
                            <input type="number" id="priceChangeMax" placeholder="Max" value="100">
                        </div>
                    </label>
                    <label>
                        Ratio Vol/Liq suspect >
                        <input type="number" id="volLiqThreshold" value="5" step="0.1">
                    </label>
                    <label>
                        Ratio Vol/MC suspect >
                        <input type="number" id="volMcThreshold" value="3" step="0.1">
                    </label>
                    <label>
                        Ratio Liq/MC suspect <
                        <input type="number" id="liqMcThreshold" value="0.05" step="0.01">
                    </label>
                </div>
            </div>
        </div>
        <h3>Filtres</h3>
        <div class="filter-options">
            <label>
                <input type="checkbox" id="filter24h" checked>
                Tokens > 24h
            </label>
            <label>
                <input type="checkbox" id="filterSuspicious">
                Masquer les tokens suspects
            </label>
            <label>
                <input type="number" id="minLiquidity" placeholder="Liquidité min ($)">
                Liquidité minimum
            </label>
            <label>
                <input type="number" id="minVolume" placeholder="Volume min ($)">
                Volume minimum
            </label>
            <!-- Nouveaux filtres Market Cap -->
            <label>
                <input type="number" id="minMc" placeholder="MCap min ($)">
                Market Cap minimum
            </label>
            <label>
                <input type="number" id="maxMc" placeholder="MCap max ($)">
                Market Cap maximum
            </label>
        </div>
        <button id="applyFilters">Appliquer les filtres</button>
    </div>

    <!-- Contrôles de comparaison -->
    <div class="comparison-controls">
        <button id="compareButton" disabled>Comparer les tokens sélectionnés</button>
        <span id="selectedCount">(0 sélectionné)</span>
    </div>

    {% if tokens %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th><a href="?sort=symbol&order={{ 'asc' if sort_by == 'symbol' and sort_order == 'desc' else 'desc' }}">Symbole</a></th>
                    <th><a href="?sort=name&order={{ 'asc' if sort_by == 'name' and sort_order == 'desc' else 'desc' }}">Nom</a></th>
                    <th><a href="?sort=liquidity&order={{ 'asc' if sort_by == 'liquidity' and sort_order == 'desc' else 'desc' }}">Liq. ($)</a></th>
                    <th><a href="?sort=v24hUSD&order={{ 'asc' if sort_by == 'v24hUSD' and sort_order == 'desc' else 'desc' }}">Vol. 24h ($)</a></th>
                    <th><a href="?sort=mc&order={{ 'asc' if sort_by == 'mc' and sort_order == 'desc' else 'desc' }}">MCap ($)</a></th>
                    <th><a href="?sort=v24hChangePercent&order={{ 'asc' if sort_by == 'v24hChangePercent' and sort_order == 'desc' else 'desc' }}" class="tooltip">
                        Δ Prix (%)
                        <span class="tooltiptext">Variation du prix sur 24h</span>
                    </a></th>
                    <th><a href="?sort=volume_liquidity_ratio&order={{ 'asc' if sort_by == 'volume_liquidity_ratio' and sort_order == 'desc' else 'desc' }}" class="tooltip">
                        Vol/Liq
                        <span class="tooltiptext">Volume 24h / Liquidité</span>
                    </a></th>
                    <th><a href="?sort=volume_mc_ratio&order={{ 'asc' if sort_by == 'volume_mc_ratio' and sort_order == 'desc' else 'desc' }}" class="tooltip">
                        Vol/MC
                        <span class="tooltiptext">Volume 24h / Market Cap</span>
                    </a></th>
                    <th><a href="?sort=liquidity_mc_ratio&order={{ 'asc' if sort_by == 'liquidity_mc_ratio' and sort_order == 'desc' else 'desc' }}" class="tooltip">
                        Liq/MC
                        <span class="tooltiptext">Liquidité / Market Cap</span>
                    </a></th>
                    <th><a href="?sort=performance&order={{ 'asc' if sort_by == 'performance' and sort_order == 'desc' else 'desc' }}" class="tooltip">
                        Score
                        <span class="tooltiptext">Score combiné basé sur les ratios</span>
                    </a></th>
                    <th><a href="?sort=is_pump&order={{ 'asc' if sort_by == 'is_pump' and sort_order == 'desc' else 'desc' }}" class="tooltip">
                        Pump
                        <span class="tooltiptext">Token avec adresse finissant par 'pump'</span>
                    </a></th>
                </tr>
            </thead>
            <tbody>
                {% for token in tokens %}
                <tr>
                    <td><input type="checkbox" class="token-select" data-address="{{ token.address }}"></td>
                    <td>{{ token.symbol }}</td>
                    <td>{{ token.name }}</td>
                    <td>{{ "{:,.0f}".format(token.liquidity).replace(',', ' ') }}</td>
                    <td>{{ "{:,.0f}".format(token.v24hUSD).replace(',', ' ') }}</td>
                    <td>{{ "{:,.0f}".format(token.mc).replace(',', ' ') }}</td>
                    <td class="{{ 'positive' if token.v24hChangePercent > 0 else 'negative' }} {{ 'suspicious' if token.v24hChangePercent > 100 or token.v24hChangePercent < -50 }}">
                        {{ "{:+.2f}%".format(token.v24hChangePercent) }}
                    </td>
                    <td class="{{ 'suspicious' if token.volume_liquidity_ratio > 5 }}">
                        {{ "{:.2f}".format(token.volume_liquidity_ratio) }}
                    </td>
                    <td class="{{ 'suspicious' if token.volume_mc_ratio > 3 }}">
                        {{ "{:.2f}".format(token.volume_mc_ratio) }}
                    </td>
                    <td class="{{ 'suspicious' if token.liquidity_mc_ratio < 0.05 }}">
                        {{ "{:.2f}".format(token.liquidity_mc_ratio) }}
                    </td>
                    <td class="{{ 'positive' if token.performance > 0 else 'negative' }}">
                        {{ "{:+.2f}".format(token.performance) }}
                    </td>
                    <td style="text-align: center;">{{ "✓" if token.is_pump else "" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p>Aucune donnée de token disponible.</p>
    {% endif %}

    <!-- Modal de comparaison -->
    <div id="comparisonModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Comparaison des tokens</h2>
            <div id="comparisonTable"></div>
        </div>
    </div>

    <!-- Script -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>